<div class="container">
  <header
    class="header"
    [ngStyle]="{ backgroundColor: isMerchant ? '#000000' : '#293628' }"
  >
    <button
      (click)="!redirectTo ? returnToStore() : returnEvent()"
      style="all: unset; cursor: pointer"
    >
      <img
        [src]="env + '/arrow-double-up-black.svg'"
        alt=""
        style="
          filter: invert(87%) sepia(6%) saturate(3262%) hue-rotate(67deg)
            brightness(104%) contrast(89%);
        "
      />
    </button>
    <p>WeDoWeLike</p>
    <span>Revistas Virtuales para Monetizar</span>
  </header>

  <button
    class="bar btn"
    *ngIf="isMerchant === false"
    (clicked)="notificationClicked()"
  >
    <p>
      Factura creada, envíala por
      <img
        [src]="env + '/whatsapp_black.svg'"
        alt=""
        style="margin: 0px 5px; margin-bottom: -4px"
      />

      a
      {{ order.items[0].saleflow.merchant.name }}
    </p>
  </button>
  <ng-container *ngIf="isMerchant">
    <div style="padding-top: 5px; margin-bottom: 5px">
      <app-dropdown-menu
        [optionsList]="deliveryStatusOptions"
        [multiple]="false"
        title="STATUS DE LA FACTURA"
        [listTitle]="orderDeliveryStatus(order.orderStatusDelivery)"
        (listValue)="changeOrderStatus($event)"
      ></app-dropdown-menu>
    </div>
    <div>
      <app-dropdown-menu
        logo="/assets/images/noimage.png"
        title="MIS LISTAS DE FACTURAS"
        listTitle="Listas"
        [optionsList]="tagOptions"
        (listValue)="addTag($event)"
        (panelState)="tagPanelState = $event"
      ></app-dropdown-menu>
    </div>
    <div
      style="background-color: #fff; padding: 0 32px 8px"
      *ngIf="tagPanelState"
    >
      <button mat-button extended (click)="createTag()" class="tag-add">
        <mat-icon>add</mat-icon>
        Crear un nuevo listado
      </button>
    </div>
  </ng-container>

  <main class="information">
    <section class="top">
      <div style="display: flex; align-items: center">
        <h2 class="top-h" *ngIf="order">
          FACTURA {{ formatId(order.dateId) }} <br />
          <button class="top-name btn" *ngIf="isMerchant">
            {{ order?.items[0].saleflow.headline }}
          </button>
        </h2>
        <img
          [src]="env + '/qr-code.svg'"
          alt=""
          style="margin-left: auto; cursor: pointer"
        />
      </div>
      <div class="info-display">
        <span class="info" style="margin-left: 0px">{{
          "Dirección: " +
            order?.items[0].saleflow.module.delivery.pickUpLocations[0].nickName
        }}</span>
      </div>
      <div class="info-display">
        <span class="info" style="margin-left: 0">
          {{ orderDate }} para
          <a style="color: #2874ad">
            {{ order?.user?.name || order?.user?.phone || order?.user?.email }}
          </a>
        </span>
      </div>
    </section>
    <section class="section">
      <h2
        class="section-title"
        [ngClass]="{
          adminView: isMerchant
        }"
      >
        Artículos facturados:
      </h2>

      <div
        class="items-container"
        *ngFor="let item of order?.items; index as i"
        style="margin-bottom: 4px"
      >
        <div class="image-container">
          <button class="btn">
            <div
              class="image"
              *ngIf="!urlIsVideo(item.item.images[0].value)"
              (click)="
                item.item.images?.length &&
                  openImageModal(item.item.images[0].value)
              "
              [ngStyle]="{
                backgroundImage: item.item.images?.length
                  ? 'url(' + item.item.images[0].value + ')'
                  : '/assets/images/noimage.png',
                backgroundRepeat: 'no-repeat',
                backgroundPosition: 'center',
                backgroundSize: 'cover'
              }"
            ></div>
            <div
              class="video-wrapper videoThumbnail"
              *ngIf="urlIsVideo(item.item.images[0].value)"
            >
              <img
                src="https://storage-rewardcharly.sfo2.digitaloceanspaces.com/new-assets/playIcon.svg"
                alt="play"
                class="playVideoIcon"
                style="padding: 1rem !important; z-index: 99"
              />

              <video
                [src]="item.item.images[0].value"
                [id]="'media' + item._id"
                class="video"
                [muted]="true"
              ></video>
            </div>
          </button>
          <div class="right" style="width: 100%">
            <div class="top-flex">
              <p class="left-text">
                {{ item.amount }}x {{ item.item.name || "artículo(s)" }}
              </p>
              <p class="right-text">
                ${{ order.subtotals[i].amount | number }}
              </p>
            </div>
            <p class="grey">
              {{ item.item.description }}
            </p>
          </div>
          <!-- <div class="question">
            <p class="top-text">Que irá escrito en el globo?</p>
            <p class="bottom-text">RespuestaID</p>
          </div> -->
        </div>
      </div>
      <div
        class="items-container space-between"
        style="padding: 11px 30px 12px 33px; margin-top: 5px"
        *ngIf="payedWithAzul"
      >
        <p class="total">Costo de envio:</p>
        <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
      </div>

      <div
        class="items-container space-between"
        style="padding: 11px 30px 12px 33px; margin-top: 5px"
      >
        <p class="total">Total facturado:</p>
        <p class="amount" [style]="{ fontSize: '21px' }">
          $ {{ payment | number : "1.2-2" }}
        </p>
      </div>
    </section>

    <section *ngIf="isMerchant" class="section" style="margin-top: 50px">
      <h2
        class="section-title"
        [ngClass]="{
          adminView: isMerchant
        }"
      >
        Pagos:
      </h2>
      <div class="items-container" style="margin-top: 5px" *ngIf="order?.ocr">
        <div
          class="image-container"
          #elemt
          (mousedown)="startDragging($event, elemt)"
          (mouseup)="stopDragging()"
          (mouseleave)="stopDragging()"
          (mousemove)="moveEvent($event, elemt)"
        >
          <button
            (click)="order.ocr && openImageModal(order.ocr.image)"
            class="btn"
          >
            <div
              class="image"
              [ngStyle]="{
                'background-image': order.ocr.image
                  ? 'url(' + order.ocr.image + ') '
                  : 'url(/assets/images/noimage.png)'
              }"
            >
              <img
                [src]="
                  order.ocr ? order.ocr.image : '/assets/images/noimage.png'
                "
                alt="item image"
                class="item-image"
              />
            </div>
          </button>
        </div>
      </div>

      <ng-container *ngIf="payedWithAzul">
        <div class="items-container space-between" style="margin-top: 4px">
          <p class="total">Subtotal a pagar:</p>
          <p class="amount">RD $ {{ payment | number : "1.2-2" }}</p>
        </div>
        <!--       <div class="items-container space-between" style="margin-top: 4px">
          <p class="total">Coins:</p>
          <p class="amount">- {{ payment | number: "1.2-2" }}</p>
        </div> -->
        <div class="items-container space-between" style="margin-top: 4px">
          <p class="total">Descuentos:</p>
          <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
        </div>

        <div class="items-container space-between" style="margin-top: 4px">
          <p class="total">Impuestos:</p>
          <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
        </div>
      </ng-container>

      <!-- <div class="items-container space-between" style="margin-top: 4px">
        <p class="total">MerchantID GiftCard</p>
        <p class="amount">$ {{ payment | number : "1.2-2" }}</p>
      </div> -->
      <div class="items-container space-between" style="margin-top: 4px">
        <p class="total">Total pagado:</p>
        <p class="amount" [style]="{ fontSize: '21px' }">
          $ {{ payment | number : "1.2-2" }}
        </p>
      </div>
    </section>

    <!-- <div *ngIf="isMerchant" class="info-card">
      <div class="square" [style]="{ background: infoCardBg }"></div>
      <div class="right">
        <p class="bold">Pago por transferencia</p>
        <p class="grey">
          Si necesitamos poner alguno info del pago then iria aqui.
        </p>
      </div>
    </div> -->

    <section class="section" *ngIf="order?.items[0].deliveryLocation">
      <h2
        class="section-title"
        style="margin-top: 50px"
        [ngClass]="{
          adminView: isMerchant
        }"
      >
        Lugar de
        {{
          order?.items[0].saleflow._id === "62ed5ad9bd70dde4db98b924"
            ? "la sesión"
            : "Entrega:"
        }}
      </h2>
      <div class="items-container column">
        <p
          class="address-name"
          *ngIf="
            (order.items[0].deliveryLocation.nickName &&
              headerService.user?._id === order.user._id) ||
            (order.items[0].deliveryLocation.nickName &&
              !order.items[0].deliveryLocation.street)
          "
        >
          {{ order.items[0].deliveryLocation.nickName }}
        </p>
        <p
          [ngClass]="{
            added: headerService.user?._id === order.user._id,
            'address-name': headerService.user?._id !== order.user._id
          }"
          *ngIf="order.items[0].deliveryLocation.street"
        >
          {{
            order.items[0].deliveryLocation.houseNumber
              ? "#" + order.items[0].deliveryLocation.houseNumber + ", "
              : ""
          }}
          {{ order.items[0].deliveryLocation.street }},
          {{
            order.items[0].deliveryLocation.referencePoint
              ? order.items[0].deliveryLocation.referencePoint + ", "
              : ""
          }}
          {{ order.items[0].deliveryLocation.city }}, República Dominicana
        </p>
      </div>
    </section>
    <section class="section" *ngIf="order?.items[0].reservation && date">
      <h2
        class="section-title"
        style="margin-top: 32px"
        [ngClass]="{
          adminView: isMerchant
        }"
      >
        Fecha de
        {{
          order?.items[0].saleflow._id === "62ed5ad9bd70dde4db98b924"
            ? "la sesión"
            : "Entrega:"
        }}
      </h2>

      <div class="items-container" style="padding: 10px 20px">
        <p class="amount">
          {{ date.weekday }}, {{ date.day }} de {{ date.month }}.
          {{ date.time }}
        </p>
      </div>
    </section>
    <!-- <section
      class="section"
      [style]="{ marginTop: '78.5px' }"
    >
      <h2 class="section-title">Entrega:</h2>
      <div class="question">
        <p class="top-text">Donde entregaremos?</p>
        <p class="bottom-text">RespuestaID</p>
      </div>
      <div class="question">
        <p class="top-text">A quien entregaremos?</p>
        <p class="bottom-text">RespuestaID</p>
      </div>
      <div class="question">
        <p class="top-text">Cuando entregaremos?</p>
        <p class="bottom-text">RespuestaID</p>
      </div>
      <button *ngIf="isMerchant" style="margin-top: 25px">
        <p class="blue">Imprime o descarga el QR que enlaza el contenido</p>
      </button>
      <button *ngIf="isMerchant" style="margin-top: 25px">
        <p class="blue">Añadir al TAG de entregado</p>
      </button>
    </section> -->

    <section
      class="section"
      style="margin-top: 32px"
      *ngIf="
        post?.message ||
        post?.from ||
        (post?.targets?.length && post.targets[0].name)
      "
    >
      <h2
        class="section-title"
        [ngClass]="{
          adminView: isMerchant
        }"
      >
        Mensaje de regalo (opcional)
      </h2>
      <div class="question" *ngIf="post.message">
        <p class="top-text">Escrito en tarjeta fisica</p>
        <p class="bottom-text">{{ post.message }}</p>
      </div>
      <div
        class="question"
        *ngIf="post.targets?.length && post.targets[0]?.name"
      >
        <p class="top-text">Nombre del sobre</p>
        <p class="bottom-text">{{ post.targets[0].name }}</p>
      </div>
      <!-- <div class="question">
        <p class="top-text">Contenido privado del QR (fotos, audio y ...)</p>
      </div> -->
      <!-- <button class="blue" style="width: 70%">
        Imprime o descarga el QR que enlaza el contenido
      </button>
      <button class="blue" (click)="moveDropdown()">
        Añadir factura al TAG de entregada
      </button> -->
    </section>

    <!-- <section
      class="section"
      *ngIf="
        order?.items[0].post &&
        (post?.message ||
          post?.from ||
          (post?.targets?.length && post?.targets[0].name) ||
          slides?.length)
      "
      style="margin-top: 32px"
    >
      <h2 class="section-title">Mensaje de regalo:</h2>

      <div
        class="buttons-share"
        *ngIf="slides?.length"
        (click)="goToPostDetail()"
      >
        <div class="buttons-area">
          <button class="btn">
            <img [src]="env + '/QR.svg'" width="34px" height="34px" />
          </button>
          <button class="btn">
            <img [src]="env + '/print.svg'" width="34px" height="34px" />
          </button>
          <button class="btn">
            <img
              [src]="env + '/download.svg'"
              width="34px"
              height="34px"
              style="filter: brightness(0)"
            />
          </button>
        </div>
        <h3 class="virtual">Mensaje Virtual</h3>
      </div>

      <div
        class="message-box"
        *ngIf="
          post?.message ||
          post?.from ||
          (post?.targets?.length && post.targets[0].name)
        "
      >
        <section *ngIf="post.message">
          <h3 class="sub">Mensaje a escribir:</h3>
          <p class="message-text inner">
            {{ post.message }}
          </p>
        </section>

        <section *ngIf="post.targets?.length && post.targets[0]?.name">
          <h3 class="sub">Título del sobre:</h3>
          <p class="message-text inner">{{ post.targets[0]?.name }}</p>
        </section>

        <section *ngIf="post.from">
          <h3 class="sub">De:</h3>
          <p class="message-text inner">{{ post.from }}</p>
        </section>
      </div>
    </section> -->
  </main>

  <qrcode
    style="display: none"
    *ngIf="order"
    #qrcode
    [qrdata]="URI + '/ecommerce/order-detail/' + order._id"
    [elementType]="'img'"
    [width]="40"
    [errorCorrectionLevel]="'M'"
    [allowEmptyString]="true"
    colorDark="#000"
  ></qrcode>

  <!-- <footer
    class="footer-display"
    [style.backgroundColor]="
      changeColor ? changeColor : headerService.colorTheme
    "
    *ngIf=""
  >

    <div class="pages-tabs">
      <div class="images-container">
        <img
          [src]="env + image.src"
          *ngFor="let image of imageList"
          class="image"
          (click)="image.callback()"
          [ngStyle]="{
            filter: image.filter && image.filter
          }"
        />
      </div>
    </div>
  </footer> -->

  <!-- Aquí hubo un merge conflict -->

  <!-- <app-sticky-button
  *ngIf="!isMerchant"
  [mode]="'fixed'"
  [bgColor]="'#2874AD'"
  [size]="'small'"
  [fontSize]="'1.25rem'"
  [text]="'VOLVER A LA TIENDA'"
  (click)="goToStore()"
  ></app-sticky-button> -->
</div>
