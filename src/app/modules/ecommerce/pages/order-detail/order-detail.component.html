<div class="container">
  <app-helper-headerv2
    [mode]="'basic'"
    [returnAble]="
      redirectTo &&
      redirectTo !== null &&
      redirectTo !== '' &&
      isMerchant &&
      merchantOwner
    "
    (returnEvent)="returnEvent()"
    [bgColor]="changeColor ? changeColor : headerService.colorTheme"
    [icon]="
      !isMerchant && merchantOwner
        ? {
            src: '/arrow-double-up.svg',
            width: 17,
            height: 21,
            callback: changeView
          }
        : null
    "
    [rightText]="
      order.user
        ? {
            text: order.user?.name || order.user?.phone || order.user?.email
          }
        : null
    "
    [icons]="[
      {
        src: '/person.svg',
        width: '13px',
        height: '17px',
        color: 'brightness(3)',
        callback: null
      }
    ]"
    [mainText]="
      !isMerchant
        ? {
            text:
              order?.items[0].saleflow.headline?.length < 38
                ? order?.items[0].saleflow.headline
                : order?.items[0].saleflow.headline.split(' ')['0'],
            fontSize: '21px',
            fontFamily: 'SfProBold'
          }
        : null
    "
    (agnosticAction)="openLogoutDialog()"
  ></app-helper-headerv2>
  <div class="top-area" *ngIf="!notify && !isMerchant">
    <button class="top-button" (click)="buyAgain()">Comprar otra vez</button>
    <button class="top-button" (click)="returnToStore()">
      Comprar otra cosa
    </button>
  </div>

  <div class="bill-area" *ngIf="notify">
    <!--     <h2 class="user-name">
      {{ order.user?.name || order.user?.phone || order.user?.email }}
    </h2> -->
    <h2 class="success">Tu factura se creó exitosamente.</h2>

    <p class="bill-clarity">
      Al “confirmar” se abrirá tu WhatsApp con la factura para
      {{ order?.items[0].saleflow.merchant.name }}.
    </p>

    <a
      [href]="messageLink"
      target="_blank"
      class="bill-button"
      (click)="notificationClicked()"
    >
      Confirmar por WhatsApp
    </a>

    <span (click)="returnToStore()" class="new-order"> Comprar otra cosa</span>
  </div>
  <main class="information" [ngStyle]="{ 'margin-top': notify ? '13px' : '' }">
    <section class="top">
      <h2 class="top-h" *ngIf="order">
        FACTURA {{ formatId(order.dateId) }} FACTURADA <br />
        <button class="top-name" (click)="sendMessage()" *ngIf="isMerchant">
          {{ order.user?.name || order.user?.phone || order.user?.email }}
        </button>
        <span class="top-headline" *ngIf="!isMerchant">{{
          order?.items[0].saleflow.headline
        }}</span>
      </h2>

      <div
        class="info-display"
        *ngIf="
          order &&
          order.items &&
          order.items.length > 0 &&
          order.items[0].saleflow.module.delivery &&
          order.items[0].saleflow.module.delivery.pickUpLocations
        "
      >
        <span class="info" style="margin-left: 0">{{
          order.items[0].saleflow.module.delivery.pickUpLocations[0].nickName
        }}</span>
        <!-- <span class="info">{{ orderStatus | titlecase }}</span> -->
      </div>

      <div class="info-display">
        <span class="info" style="margin-left: 0">{{ orderDate }}</span>
        <!-- <span class="info">{{ orderStatus | titlecase }}</span> -->
      </div>

      <a
        *ngIf="!notify && !isMerchant"
        [href]="messageLink"
        target="_blank"
        class="new-order"
      >
        Confirmar por WhatsApp</a
      >
    </section>
    <section class="section">
      <h2 class="section-title">Artículos facturados:</h2>
      <div
        class="items-container space-between"
        *ngFor="let item of order?.items"
      >
        <ng-container *ngIf="!item.params?.length || customizer">
          <div
            class="image"
            (click)="
              item.item.images?.length &&
                openImageModal(item.item.images[0].value)
            "
            [ngStyle]="{
              backgroundImage: item.item.images?.length
                ? 'url(' + item.item.images[0].value + ')'
                : '/assets/images/noimage.png',
              backgroundRepeat: 'no-repeat',
              backgroundPosition: 'center',
              backgroundSize: 'cover'
            }"
          ></div>
        </ng-container>
        <ng-container *ngIf="item.params?.length && !customizer">
          <div *ngFor="let paramValue of item.item.params[0].values">
            <div
              class="image"
              *ngIf="
                item.params[0].param == item.item.params[0]._id &&
                item.params[0].paramValue == paramValue._id
              "
              [ngStyle]="{
                backgroundImage: paramValue.image
                  ? 'url(' +
                    paramValue.image +
                    '), url(/assets/images/noimage.png)'
                  : '/assets/images/noimage.png',
                backgroundRepeat: 'no-repeat',
                backgroundPosition: 'center',
                backgroundSize: 'cover'
              }"
              (click)="openImageModal(paramValue.image)"
            ></div>
          </div>
        </ng-container>

        <div class="amount" [style.paddingRight]="'18px'">
          1x RD $ {{ item.item.pricing | number : "1.2-2" }}
        </div>
      </div>
      <div
        class="items-container space-between"
        style="padding: 11px 30px 12px 33px; margin-top: 5px"
      >
        <p class="total">Costo de envio:</p>
        <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
      </div>

      <div
        class="items-container space-between"
        style="padding: 11px 30px 12px 33px; margin-top: 5px"
      >
        <p class="total">Total facturado:</p>
        <p class="amount">RD $ {{ payment | number : "1.2-2" }}</p>
      </div>
    </section>

    <section class="section" style="margin-top: 50px">
      <h2 class="section-title">Sobre el pago:</h2>
      <div
        class="items-container"
        style="margin-top: 5px"
        *ngIf="order?.ocr || payedWithAzul"
      >
        <div
          class="image-container"
          #elemt
          (mousedown)="startDragging($event, elemt)"
          (mouseup)="stopDragging()"
          (mouseleave)="stopDragging()"
          (mousemove)="moveEvent($event, elemt)"
        >
          <button (click)="order.ocr ? openImageModal(order.ocr.image) : null">
            <div
              class="image"
              [ngStyle]="{
                'background-image':
                  order.ocr && order.ocr.image
                    ? 'url(' + order.ocr.image + ') '
                    : payedWithAzul
                    ? 'url(https://www.azul.com.do/SiteAssets/v2theme/images/header/AZULLogo.png)'
                    : 'url(/assets/images/noimage.png)'
              }"
            >
              <!-- <img
                 [src]="
                   order.ocr ? order.ocr.image : '/assets/images/noimage.png'
                 "
                 alt="item image"
                 class="item-image"
               /> -->
            </div>
          </button>
        </div>
      </div>

      <div class="items-container space-between" style="margin-top: 4px">
        <p class="total">Subtotal a pagar:</p>
        <p class="amount">RD $ {{ payment | number : "1.2-2" }}</p>
      </div>
      <!--       <div class="items-container space-between" style="margin-top: 4px">
        <p class="total">Coins:</p>
        <p class="amount">- {{ payment | number: "1.2-2" }}</p>
      </div> -->
      <div class="items-container space-between" style="margin-top: 4px">
        <p class="total">Descuentos:</p>
        <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
      </div>

      <div class="items-container space-between" style="margin-top: 4px">
        <p class="total">Impuestos:</p>
        <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
      </div>

      <div class="items-container space-between" style="margin-top: 4px">
        <p class="total">Total Pagado:</p>
        <p class="amount">RD $ {{ payment | number : "1.2-2" }}</p>
      </div>
    </section>

    <section class="section" *ngIf="order?.items[0].deliveryLocation">
      <h2 class="section-title" style="margin-top: 50px">
        Lugar de
        {{
          order?.items[0].saleflow.merchant._id === "62ed55eecd8fc9d59c8d7b6b"
            ? " la sesión:"
            : " Entrega:"
        }}
      </h2>

      <div class="items-container column">
        <p
          class="address-name"
          *ngIf="
            (order.items[0].deliveryLocation.nickName &&
              headerService.user?._id === order.user._id) ||
            (order.items[0].deliveryLocation.nickName &&
              !order.items[0].deliveryLocation.street)
          "
        >
          {{ order.items[0].deliveryLocation.nickName }}
        </p>
        <p
          [ngClass]="{
            added: headerService.user?._id === order.user._id,
            'address-name': headerService.user?._id !== order.user._id
          }"
          *ngIf="order.items[0].deliveryLocation.street"
        >
          {{
            order.items[0].deliveryLocation.houseNumber
              ? "#" + order.items[0].deliveryLocation.houseNumber + ", "
              : ""
          }}
          {{ order.items[0].deliveryLocation.street }},
          {{
            order.items[0].deliveryLocation.referencePoint
              ? order.items[0].deliveryLocation.referencePoint + ", "
              : ""
          }}
          {{ order.items[0].deliveryLocation.city }}, República Dominicana
        </p>
      </div>
    </section>

    <section class="section" *ngIf="order?.items[0].reservation && date">
      <h2 class="section-title" style="margin-top: 32px">
        Fecha de la sesión:
      </h2>

      <div class="items-container" style="padding: 10px 32px">
        <p class="amount">
          {{ date.weekday }}, {{ date.day }} de {{ date.month }}.
          {{ date.time }}
        </p>
      </div>
    </section>

    <section
      class="section"
      *ngIf="
        order?.items[0].post &&
        (post?.message ||
          post?.from ||
          (post?.targets?.length && post?.targets[0].name) ||
          slides?.length)
      "
      style="margin-top: 32px"
    >
      <h2 class="section-title">Mensaje de regalo:</h2>

      <div
        class="buttons-share"
        *ngIf="slides?.length"
        (click)="goToPostDetail()"
      >
        <div class="buttons-area">
          <button class="btn">
            <img [src]="env + '/QR.svg'" width="34px" height="34px" />
          </button>
          <button class="btn">
            <img [src]="env + '/print.svg'" width="34px" height="34px" />
          </button>
          <button class="btn">
            <img
              [src]="env + '/download.svg'"
              width="34px"
              height="34px"
              style="filter: brightness(0)"
            />
          </button>
        </div>
        <h3 class="virtual">Mensaje Virtual</h3>
      </div>

      <div
        class="message-box"
        *ngIf="
          post?.message ||
          post?.from ||
          (post?.targets?.length && post.targets[0].name)
        "
      >
        <section *ngIf="post.message">
          <h3 class="sub">Mensaje a escribir:</h3>
          <p class="message-text inner">
            {{ post.message }}
          </p>
        </section>

        <section *ngIf="post.targets?.length && post.targets[0]?.name">
          <h3 class="sub">Título del sobre:</h3>
          <p class="message-text inner">{{ post.targets[0]?.name }}</p>
        </section>

        <section *ngIf="post.from">
          <h3 class="sub">De:</h3>
          <p class="message-text inner">{{ post.from }}</p>
        </section>
      </div>
    </section>
    <section class="section" *ngIf="customizer" style="margin-top: 32px">
      <h2 class="section-title">Personalización:</h2>
      <div class="items-container" style="flex-direction: column">
        <table>
          <tr *ngFor="let detail of customizerDetails">
            <th>{{ detail.name }}</th>
            <td>{{ detail.value }}</td>
          </tr>
        </table>
        <div *ngIf="customizer.preview">
          <img class="customizer-preview" [src]="customizer.preview" alt="" />
        </div>
      </div>
    </section>
  </main>

  <qrcode
    style="display: none"
    *ngIf="order"
    #qrcode
    [qrdata]="URI + '/ecommerce/order-detail/' + order._id"
    [elementType]="'img'"
    [width]="40"
    [errorCorrectionLevel]="'M'"
    [allowEmptyString]="true"
    colorDark="#000"
  ></qrcode>

  <footer
    class="footer-display"
    [style.backgroundColor]="
      changeColor ? changeColor : headerService.colorTheme
    "
  >
    <!--
      <div
        class="left-arrow"
        *ngIf="this.orderInDayIndex > 0 || orderBeforeOrderDay"
        (click)="goToNextOrPreviousOrder('PREVIOUS')"
      >
        <img
          src="https://storage-rewardcharly.sfo2.digitaloceanspaces.com/new-assets/arrow-left-white.svg"
          alt=""
        />
      </div>
    -->

    <div class="pages-tabs">
      <div class="images-container">
        <img
          [src]="env + image.src"
          *ngFor="let image of imageList"
          class="image"
          (click)="image.callback()"
          [ngStyle]="{
            filter: image.filter && image.filter
          }"
        />
      </div>
    </div>

    <!--
      <div
        class="right-arrow"
        *ngIf="
          this.orderInDayIndex < this.ordersInTheSameDay.length - 1 ||
          orderAfterOrderDay
        "
        (click)="goToNextOrPreviousOrder('NEXT')"
      >
        <img
          src="https://storage-rewardcharly.sfo2.digitaloceanspaces.com/new-assets/arrow-right-white.svg"
          alt=""
        />
      </div>
    -->
  </footer>

  <!-- Aquí hubo un merge conflict -->

  <!-- <app-sticky-button
  *ngIf="!isMerchant"
  [mode]="'fixed'"
  [bgColor]="'#2874AD'"
  [size]="'small'"
  [fontSize]="'1.25rem'"
  [text]="'VOLVER A LA TIENDA'"
  (click)="goToStore()"
  ></app-sticky-button> -->
</div>
