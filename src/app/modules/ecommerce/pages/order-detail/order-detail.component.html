<!-- <app-navigation [opened]="openNavigation" (closed)="openNavigation = false"> -->
  <div class="container">
    <div class="header-navigation">
      <mat-accordion>
        <mat-expansion-panel
          (opened)="panelOpenState = true"
          (closed)="panelOpenState = false"
          disabled
          class="panel"
          [ngClass]="{ 'mat-elevation-z0': !panelOpenState }"
        >
          <mat-expansion-panel-header>
            <mat-panel-title>
              <div class="merchant-info">
                <a>
                  <mat-icon
                    style="
                      font-size: 30px;
                      margin-top: 0.1em;
                      color: black;
                      margin-right: 14px;
                    "
                    (click)="returnEvent()"
                    >keyboard_arrow_left</mat-icon
                  >
                </a>
                <div
                  class="icon"
                  [style.background]="
                    _DomSanitizer.bypassSecurityTrustStyle(
                      'url(' +
                        order?.items[0].saleflow.merchant?.image +
                        ') no-repeat center center / cover #e9e371'
                    )
                  "
                ></div>
                <p class="title" style="margin-left: 12px">
                  {{
                    order?.items[0].saleflow.merchant?.name.length < 26
                      ? order?.items[0].saleflow.merchant?.name
                      : (order?.items[0].saleflow.merchant?.name.slice(0, 26) +
                          ".." || "Tienda" | titlecase)
                  }}
                  <span>facturó a {{ order?.user?.name || order?.user?.phone || order?.user?.email }}</span>
                </p>
                
              </div>
            </mat-panel-title>
            <!-- <p class="userId" *ngIf="order">
              {{ order.user.name || order.user.phone || order.user.email }}
            </p> -->
            <button
              style="
                all: unset;
                cursor: pointer;
              "
              *ngIf="messageLink"
              (click)="goToWhatsapp()"
            >
              <img
                [src]="env + '/whatsApp-img.webp'"
                style="height: 25px; width: 25px"
                alt=""
              />
            </button>
          </mat-expansion-panel-header>
          <!-- <app-contact-header
            [link]="link"
            [chatLink]="chatLink"
            [bio]="order?.items[0].saleflow.merchant.bio"
            [contact]="headerService.merchantContact"
          ></app-contact-header> -->
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <!-- <button
      style="
        all: unset;
        cursor: pointer;
        position: absolute;
        top: 51px;
        right: 20px;
      "
      *ngIf="messageLink"
      (click)="goToWhatsapp()"
    >
      <img
        [src]="env + '/whatsApp-img.webp'"
        style="height: 22px; width: 22px"
        alt=""
      />
    </button> -->

    <app-progress-slider
      [title]=""
      [statusList]="statusList"
      [activeIndex]="activeStatusIndex"
      [isAdmin]="isMerchant"
      [orderId]="orderId"
      (statusUpdated)="handleStatusUpdated($event)"
    ></app-progress-slider>

    <div style="position: fixed; max-width: 500px; width: 100%; bottom: 100px">
      <a
        mat-mini-fab
        class="fixed-bottom-button right"
        *ngIf="isMerchant === false"
        [href]="messageLink"
        target="_blank"
      >
        <img
          [src]="env + '/whatsapp_black.svg'"
          alt=""
          style="
            filter: brightness(0) saturate(100) invert(76%) sepia(57%)
              saturate(301%) hue-rotate(90deg) brightness(87%) contrast(90%);
            margin-top: -2px;
          "
        />
      </a>
    </div>

    <section class="top" *ngIf="order">
      <div style="display: grid">
        <div style="display: flex; align-items: center; margin-bottom: 10px">
          <p style="margin-right: auto">
            Factura <br />
            <!-- <button class="top-name btn" *ngIf="isMerchant">
              {{ order?.items[0].saleflow.headline }}
            </button> -->
          </p>

          <span>
            {{ formatId(order.dateId) }}
          </span>
        </div>
        <div style="display: flex; align-items: center">
          <p style="margin-right: auto">Fecha <br /></p>
          <span style="text-transform: uppercase">
            {{ orderDate }}
          </span>
          <!-- <p>Dirección {{ order?.items[0].saleflow.merchant?.address }}</p> -->
        </div>
      </div>
    </section>

    <main class="information">
      <section class="section">
        <p
          class="section-label"
          [ngClass]="{
            adminView: isMerchant
          }"
        >
          DETALLES:
        </p>

        <mat-accordion>
          <mat-expansion-panel
            (opened)="panelOpenState = true"
            (closed)="panelOpenState = false"
            hideToggle
          >
            <mat-expansion-panel-header>
              <div
                class="between"
                style="display: flex; align-items: center; flex-wrap: wrap"
              >
                <div style="display: flex; align-items: center">
                  <p class="inner-title responsive-flex" style="margin: 0">
                    {{ this.order?.items.length }} Artículos facturados
                  </p>
                  <mat-icon
                    [ngStyle]="{
                      color: '#7B7B7B',
                      marginLeft: '10px'
                    }"
                    >{{
                      panelOpenState
                        ? "keyboard_arrow_down"
                        : "keyboard_arrow_right"
                    }}
                  </mat-icon>
                </div>
                <h2
                  class="inner-title"
                  style="
                    position: absolute;
                    right: 18px;
                    margin: 0;
                    font-family: 'InterBold';
                  "
                >
                  RD $ {{ itemsAmount | number : "1.2-2" }}
                </h2>
              </div>
            </mat-expansion-panel-header>
            <ng-container>
              <div
                class="items-container no-padding"
                style="margin-bottom: 5px"
              >
                <div
                  class="image-container"
                  *ngFor="let item of order?.items; index as i"
                >
                  <button class="btn">
                    <div
                      class="image"
                      *ngIf="
                        !item.item.images.length ||
                        !item.item.images ||
                        (item.item.images?.length &&
                          !urlIsVideo(item.item.images[0].value))
                      "
                      (click)="
                        item.item.images?.length &&
                          openImageModal(item.item.images[0].value)
                      "
                      [ngStyle]="{
                        backgroundImage: item.item.images?.length
                          ? 'url(' + item.item.images[0].value + ')'
                          : 'url(/assets/images/noimage.png)',
                        backgroundRepeat: 'no-repeat',
                        backgroundPosition: 'center',
                        backgroundSize: 'cover'
                      }"
                    ></div>
                    <div
                      class="video-wrapper videoThumbnail"
                      *ngIf="
                        item.item.images?.length &&
                        urlIsVideo(item.item.images[0].value)
                      "
                      (click)="playVideoOnFullscreen('media' + item._id)"
                    >
                      <img
                        src="https://storage-rewardcharly.sfo2.digitaloceanspaces.com/new-assets/playIcon.svg"
                        alt="play"
                        class="playVideoIcon"
                        style="padding: 1rem !important; z-index: 99"
                      />

                      <video
                        [src]="item.item.images[0].value"
                        [id]="'media' + item._id"
                        class="video"
                        [muted]="true"
                      ></video>
                    </div>
                  </button>
                </div>
              </div>

              <div *ngFor="let item of order?.items; index as i">
                <div class="answers-by-item" *ngIf="answersByItem[item._id]">
                  <button class="blue" *ngFor="let item of order.items">
                    Respuestas de
                    {{
                      item.item?.name ? item.item?.name : "Artículo sin nombre"
                    }}
                  </button>
                </div>
              </div>
              <section
                class="section"
                style="margin-top: 29px"
                *ngIf="order?.ocr || payedWithAzul"
              >
                <ng-container *ngIf="payedWithAzul">
                  <div
                    class="items-container space-between"
                    style="margin-top: 4px"
                  >
                    <p class="total">Subtotal a pagar:</p>
                    <p class="amount">RD $ {{ payment | number : "1.2-2" }}</p>
                  </div>
                  <!--       <div class="items-container space-between" style="margin-top: 4px">
            <p class="total">Coins:</p>
            <p class="amount">- {{ payment | number: "1.2-2" }}</p>
          </div> -->
                  <div
                    class="items-container space-between"
                    style="margin-top: 4px"
                  >
                    <p class="total">Descuentos:</p>
                    <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
                  </div>

                  <div
                    class="items-container space-between"
                    style="margin-top: 4px"
                  >
                    <p class="total">Impuestos:</p>
                    <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
                  </div>
                </ng-container>

                <!-- <div class="items-container space-between" style="margin-top: 4px">
          <p class="total">MerchantID GiftCard</p>
          <p class="amount">$ {{ payment | number : "1.2-2" }}</p>
        </div> -->

                <div class="bottom-section" *ngIf="deliveryAmount">
                  <p class="inner-title">Zona de entrega</p>
                  <p class="inner-title">
                    RD $ {{ deliveryAmount | number : "1.2-2" }}
                  </p>
                </div>

                <div class="bottom-section" *ngIf="paymentFeeAmount">
                  <p class="inner-title">Comisión de método de pago</p>
                  <p class="inner-title">
                    RD $ {{ paymentFeeAmount | number : "1.2-2" }}
                  </p>
                </div>

                <div
                  class="items-container space-between"
                  style="margin: 0px; padding: 0px"
                >
                  <p class="total">Monto Total:</p>
                  <p class="amount" [style]="{ fontSize: '21px' }">
                    $ {{ payment | number : "1.2-2" }}
                  </p>
                </div>
                <div
                  class="items-container"
                  style="margin-top: 33px; padding: 0px"
                >
                  <div class="image-container">
                    <button
                      (click)="
                        order.ocr ? openImageModal(order.ocr.image) : null
                      "
                      class="btn"
                    >
                      <div
                        class="image"
                        [ngStyle]="{
                          'background-image':
                            order.ocr && order.ocr.image
                              ? 'url(' + order.ocr.image + ') '
                              : payedWithAzul
                              ? 'url(https://www.azul.com.do/SiteAssets/v2theme/images/header/AZULLogo.png)'
                              : 'url(/assets/images/noimage.png)'
                        }"
                      ></div>
                    </button>
                    <div class="payment-info">
                      <span>Pago por {{ paymentType }}</span>
                      <div style="margin-top: 12px">
                        <div
                          *ngIf="order.orderStatus === 'to confirm'"
                          class="status pending"
                        >
                          Pago por confirmar
                        </div>
                        <div
                          *ngIf="order.orderStatus === 'completed'"
                          class="status confirmed"
                        >
                          Pago confirmado
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </ng-container>
          </mat-expansion-panel>
        </mat-accordion>

        <div
          class="items-container space-between"
          style="padding: 11px 30px 12px 33px; margin-top: 5px"
          *ngIf="payedWithAzul"
        >
          <p class="total">Costo de envio:</p>
          <p class="amount">RD $ {{ 0 | number : "1.2-2" }}</p>
        </div>
      </section>

      <div class="section">
        <ng-container *ngIf="deliveryImages?.deliveryZone">
          <p class="section-label">ZONA DE ENTREGA</p>
          <div class="questions">
            <!-- <p class="label">Zona de entrega</p> -->
            <p class="label gray-out capitalize">
              {{ deliveryImages?.deliveryZone.zona }}
            </p>
          </div>
        </ng-container>
        <p class="section-label">LUGAR DE ENTREGA</p>
        <div class="questions" *ngIf="order?.items[0].deliveryLocation">
          <p class="label gray-out capitalize">
            <ng-container *ngIf="!order?.items[0]?.deliveryLocation?.street">
              {{ order?.items[0]?.deliveryLocation?.nickName }}, República
              Dominicana
            </ng-container>
            <ng-container *ngIf="order?.items[0]?.deliveryLocation?.street">
              {{
                order?.items[0]?.deliveryLocation?.houseNumber
                  ? "#" + order?.items[0]?.deliveryLocation?.houseNumber + ", "
                  : ""
              }}
              {{ order?.items[0]?.deliveryLocation?.street }},
              {{
                order?.items[0]?.deliveryLocation?.referencePoint
                  ? order?.items[0]?.deliveryLocation?.referencePoint + ", "
                  : ""
              }}
              {{ order?.items[0]?.deliveryLocation?.city }}, República
              Dominicana
            </ng-container>
          </p>
        </div>

        <ng-container *ngIf="order?.receiverData">
          <p class="section-label">RECIPIENTE</p>
          <div class="questions">
            <p
              class="label body gray-out capitalize"
              *ngIf="order?.receiverData?.receiver"
            >
              Lo recibirá: {{ order?.receiverData?.receiver }}
            </p>
            <p
              class="label body gray-out capitalize m-top"
              *ngIf="order?.receiverData?.receiverPhoneNumber"
            >
              Teléfono:
              {{ order?.receiverData?.receiverPhoneNumber }}
            </p>
            <p
              class="label body gray-out capitalize m-top"
              *ngIf="order?.receiverData?.sender"
            >
              {{ order?.receiverData?.sender }}
            </p>
          </div>
        </ng-container>

        <ng-container *ngIf="deliveryImages?.reservation">
          <p class="section-label">TIEMPO DE LA ENTREGA</p>
          <div class="questions">
            <p class="label body gray-out capitalize">
              {{ displayReservation(deliveryImages?.reservation) }}
            </p>
          </div>
        </ng-container>
      </div>

      <div
        class="section"
        *ngIf="
          post &&
          (post?.message ||
            post?.from ||
            post?.envelopeText ||
            post?.virtualMessage ||
            (post?.targets?.length && post.targets[0].name))
        "
      >
        <p class="section-label">MENSAJE DE REGALO</p>

        <!-- 
          Condicional que tenía el div de abajo
          *ngIf="
            !post.envelopePresentation ||
            (post.envelopePresentation &&
              post.envelopePresentation === 'QR-TEXT')
          " 
        -->
        <div class="questions">
          <div class="question firstQuestion">
            <div class="flex">
              <qrcode
                *ngIf="post && post.virtualMessage"
                [qrdata]="entityTemplateLink"
                [elementType]="'img'"
                [width]="82"
                [errorCorrectionLevel]="'M'"
                [style.cursor]="'pointer'"
                [allowEmptyString]="true"
                colorDark="#000000"
                (click)="downloadQr(qrcodeTemplate)"
              ></qrcode>
              <div
                [ngStyle]="{
                  marginLeft: '1rem',
                  alignSelf: 'flex-start'
                }"
                *ngIf="
                  post.virtualMessage || !post.hasOwnProperty('virtualMessage')
                "
              >
                <p class="top-text">Mensaje de dedicatoria</p>
                <p class="bottom-text">
                  <ng-container *ngIf="post?.envelopeText">
                    <!-- {{ post?.envelopeText }} -->
                    Contenido privado
                  </ng-container>
                </p>
              </div>

              <div
                *ngIf="
                  !post.virtualMessage && post.hasOwnProperty('virtualMessage')
                "
              >
                <p class="top-text" style="margin: 0px">
                  Mensaje de dedicatoria
                </p>
                <p class="bottom-text">
                  <ng-container *ngIf="post?.envelopeText">
                    <!-- {{ post?.envelopeText }} -->
                    Contenido privado
                  </ng-container>
                </p>
              </div>
            </div>
            <button
              *ngIf="
                post.virtualMessage || !post.hasOwnProperty('virtualMessage')
              "
              style="margin-left: 5px; margin-top: 5px"
              class="blue"
              (click)="downloadQr(qrcodeTemplate)"
            >
              Imprime o descarga el QR que sirve para acceder al contenido del
              mensaje virtual
            </button>
          </div>
        </div>
      </div>
    </main>

    <qrcode
      style="display: none"
      *ngIf="order"
      #qrcode
      [qrdata]="URI + '/ecommerce/order-detail/' + order._id"
      [elementType]="'img'"
      [width]="40"
      [errorCorrectionLevel]="'M'"
      [allowEmptyString]="true"
      colorDark="#000"
    ></qrcode>

    <div
      style="visibility: hidden; position: absolute; z-index: -99; bottom: 0"
    >
      <qrcode
        *ngIf="post"
        #qrcodeTemplate
        [qrdata]="entityTemplateLink"
        [elementType]="'img'"
        [width]="500"
        [style.margin-top.px]="-25"
        [errorCorrectionLevel]="'M'"
        [allowEmptyString]="true"
        colorDark="#000000"
      ></qrcode>
    </div>
    <a
      id="mailLink"
      [style.display]="'none'"
      href="mailto:{{order.user.email}}"
    ></a>

    <footer class="bottom-footer" *ngIf="isMerchant" (click)="goToBenefits()">
      <p>Beneficio: ${{ itemsAmount | number : "1.2-2" }}</p>
    </footer>
  </div>
<!-- </app-navigation> -->
