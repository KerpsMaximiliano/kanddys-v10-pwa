<div class="form-wrapper">
  <app-helper-header
    *ngIf="!steps[currentStep].hideHeader && (!steps[currentStep].headerMode || steps[currentStep].headerMode === 'v1')"
    [middleText]="
      !steps[currentStep].headerTextSide ||
      steps[currentStep].headerTextSide === 'CENTER'
        ? steps[currentStep].headerText
        : null
    " [searchAble]="false" bgcolor="#ffffff" [basic]="false" position="fixed" [leftIconText]="
      steps[currentStep].headerTextSide === 'LEFT'
        ? steps[currentStep].headerText
        : null
    " [middleTextFontFamily]="'SfProRegular'" [middleTextFontSize]="'17px'" middleTextColor="#7b7b7b"
    [cart]="steps[currentStep].showShoppingCartOnCurrentStep" [cartCallback]="steps[currentStep].shoppingCartCallback"
    [shadow]="false" (onClose)="
      currentStep > 0 &&
      shouldScrollBackwards &&
      !steps[currentStep].customScrollToStepBackwards
        ? scrollToStep(this.currentStep - 1, false)
        : steps[currentStep].customScrollToStepBackwards
        ? steps[currentStep].customScrollToStepBackwards(stepFunctionParams)
        : null
    "></app-helper-header>

  <app-helper-headerv2 [mode]="'options'" [fixed]="true"
    *ngIf="!steps[currentStep].hideHeader && steps[currentStep].headerMode === 'v2'" [returnAble]="true" [billId]="''"
    [itemId]="!steps[currentStep].headerTextSide ||
    steps[currentStep].headerTextSide === 'CENTER'
      ? steps[currentStep].headerText
      : null" [leftText]="''" [rightText]="''" [returnAble]="shouldScrollBackwards" (returnEvent)="currentStep > 0 &&
    shouldScrollBackwards &&
    !steps[currentStep].customScrollToStepBackwards
      ? scrollToStep(this.currentStep - 1, false)
      : steps[currentStep].customScrollToStepBackwards
      ? steps[currentStep].customScrollToStepBackwards(stepFunctionParams)
      : null" [bgColor]="'#2874ad'">
  </app-helper-headerv2>

  <ng-container *ngFor="let currentStepObject of steps; let currentStepIndex = index">
    <div class="form-step" [ngStyle]="!steps[currentStep].hideHeader ? {
      paddingTop: '60px'
    } : steps[currentStep].styles ? steps[currentStep].styles : null" [id]="'step-' + currentStepIndex" *ngIf="
        scrollableForm || (!scrollableForm && currentStepIndex === currentStep)
      ">
      <ng-container *ngIf="currentStepObject.pageHeader">
        <div [ngStyle]="
          currentStepObject.pageHeader?.styles
            ? currentStepObject.pageHeader?.styles
            : null
        " (click)="
            currentStepObject.pageHeader.callback ? 
              currentStepObject.pageHeader.callback(stepFunctionParams) : 
              null
          ">
          {{currentStepObject.pageHeader.text}}
        </div>
      </ng-container>

      <form [formGroup]="dataModel">
        <ng-container *ngFor="
            let currentField of currentStepObject['fieldsList'];
            let currentFieldIndex = index
          " [formGroupName]="currentStepIndex + 1">
          <ng-container *ngIf="currentStepObject['embeddedComponents']">
            <ng-container *ngFor="
                let currentEmbeddedComponent of currentStepObject[
                  'embeddedComponents'
                ]
              ">
              <div *ngIf="
                  currentEmbeddedComponent.beforeIndex === currentFieldIndex
                " [ngStyle]="
                  currentEmbeddedComponent.containerStyles
                    ? currentEmbeddedComponent.containerStyles
                    : null
                ">
                <app-dynamic-component [component]="currentEmbeddedComponent.component"
                  [componentInputs]="currentEmbeddedComponent.inputs"
                  [componentOutputs]="currentEmbeddedComponent.outputs"
                  [shouldRemoveItFromTheView]="currentEmbeddedComponent.shouldRerender">
                  ></app-dynamic-component>
              </div>
            </ng-container>
          </ng-container>

          <!-- STANDARD INPUTS LIKE TEXT NUMBER EMAIL PASSWORDS ARE RENDERED HERE     -->
          <div *ngIf="
              ['text', 'number', 'email', 'password'].includes(
                currentField.inputType
              ) || !currentField.inputType
            " [ngStyle]="
              currentField.styles.containerStyles
                ? currentField.styles.containerStyles
                : null
            ">
            <!-- SINGLE INPUTS GO HERE -->
            <ng-container *ngIf="!currentField.multiple">
              <span *ngIf="currentField.topLabelAction" class="input-label-top-action" [ngStyle]="
                  currentField.styles.topLabelActionStyles
                    ? currentField.styles.topLabelActionStyles
                    : null
                " (click)="
                  currentField.topLabelAction.clickable
                    ? currentField.topLabelAction.callback(stepFunctionParams)
                    : null
                ">
                {{ currentField.topLabelAction.text }}
              </span>

              <label [for]="currentField.name" class="input-label" [ngStyle]="
                  currentField.styles.labelStyles
                    ? currentField.styles.labelStyles
                    : null
                ">
                {{ currentField.label }}
              </label>

              <label [for]="currentField.name" *ngIf="currentField.sublabel" class="input-label" [ngStyle]="
              currentField.styles.subLabelStyles
                ? currentField.styles.subLabelStyles
                : null
              ">
                {{ currentField.sublabel }}
              </label>

              <div class="input" *ngIf="currentField.shouldFormatNumber" [ngStyle]="{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'flex-start',
                  backgroundColor: 'white'
                }">
                {{ currentField.formattedValue }}
              </div>

              <input [id]="currentField.name" [name]="currentField.name" [formControlName]="currentField.name"
                [type]="currentField.inputType || 'text'" [min]="
                  currentField.inputType === 'number' &&
                  currentField.onlyAllowPositiveNumbers
                    ? 0
                    : null
                " [placeholder]="currentField.placeholder" [ngClass]="
                  currentField.styles.customClassName
                    ? currentField.styles.customClassName
                    : 'input'
                " [ngStyle]="
                  currentField.styles.fieldStyles &&
                  !currentField.styles.customClassName
                    ? currentField.styles.fieldStyles
                    : null
                " />

              <span *ngIf="currentField.bottomLabel" class="input-label-bottom" [ngStyle]="
                  currentField.styles.bottomLabelStyles
                    ? currentField.styles.bottomLabelStyles
                    : null
                " (click)="
                  currentField.bottomLabel.clickable
                    ? currentField.bottomLabel.callback(stepFunctionParams)
                    : null
                ">
                {{ currentField.bottomLabel.text }}
              </span>
            </ng-container>

            <!-- MULTIPLE INPUTS GO HERE -->
            <div [formArrayName]="currentField.name" *ngIf="currentField.multiple">
              <h3 class="input-label" [ngStyle]="
                  currentField.styles.labelStyles
                    ? currentField.styles.labelStyles
                    : null
                ">
                {{ currentField.label }}
              </h3>

              <ng-container *ngFor="
                  let field of currentField.fieldControl.controls;
                  let i = index
                ">
                <div [ngStyle]="{
                    position: 'relative',
                    width: '100%',
                    margin: '0px'
                  }">
                  <input [formControlName]="i" [type]="currentField.inputType || 'text'"
                    [placeholder]="currentField.placeholder" class="input" id="{{ currentField.name }}-{{ i }}"
                    [ngStyle]="
                      currentField.styles.fieldStyles
                        ? currentField.styles.fieldStyles
                        : null
                    " (keypress)="
                      onMultipleInputEnterPress(
                        $event,
                        addOneMoreInputToCurrentFormArray,
                        currentField.fieldControl,
                        currentField.name
                      )
                    " />
                  <div class="close-button" *ngIf="currentField.fieldControl.length > 1" (click)="
                      removeInputToCurrentFormArray(
                        currentField.fieldControl,
                        currentField.name,
                        i
                      )
                    ">
                    X
                  </div>
                </div>

                <span *ngIf="currentField.bottomLabel" class="input-label-bottom" [ngStyle]="
                    currentField.styles.bottomLabelStyles
                      ? currentField.styles.bottomLabelStyles
                      : null
                  ">
                  {{ currentField.bottomLabel.text }}
                </span>
              </ng-container>
            </div>
          </div>

          <!-- TEXTAREA GOES HERE -->
          <div *ngIf="currentField.inputType === 'textarea'" [ngStyle]="
              currentField.styles.containerStyles
                ? currentField.styles.containerStyles
                : null
            ">
            <ng-container *ngIf="!currentField.multiple">
              <span *ngIf="currentField.topLabelAction" class="input-label-top-action" [ngStyle]="
                  currentField.styles.topLabelActionStyles
                    ? currentField.styles.topLabelActionStyles
                    : null
                " (click)="
                  currentField.topLabelAction.clickable
                    ? currentField.topLabelAction.callback(stepFunctionParams)
                    : null
                ">
                {{ currentField.topLabelAction.text }}
              </span>

              <label [for]="currentField.name" class="input-label" [ngStyle]="
                  currentField.styles.labelStyles
                    ? currentField.styles.labelStyles
                    : null
                ">
                {{ currentField.label }}
              </label>

              <label [for]="currentField.name" *ngIf="currentField.sublabel" class="input-label" [ngStyle]="
                  currentField.styles.subLabelStyles
                    ? currentField.styles.subLabelStyles
                    : null
                ">
                {{ currentField.sublabel }}
              </label>

              <textarea [id]="currentField.name" [placeholder]="currentField.placeholder" [name]="currentField.name"
                [formControlName]="currentField.name" [placeholder]="currentField.placeholder" class="textarea"
                [ngStyle]="
                  currentField.styles.fieldStyles
                    ? currentField.styles.fieldStyles
                    : null
                "></textarea>

              <span *ngIf="currentField.bottomLabel" class="input-label-bottom" [ngStyle]="
                  currentField.styles.bottomLabelStyles
                    ? currentField.styles.bottomLabelStyles
                    : null
                " (click)="
                  currentField.bottomLabel.clickable
                    ? currentField.bottomLabel.callback(stepFunctionParams)
                    : null
                ">
                {{ currentField.bottomLabel.text }}
              </span>
            </ng-container>
          </div>

          <!-- PHONE INPUTS GO HERE -->
          <div *ngIf="currentField.inputType === 'phone'" [ngStyle]="
          currentField.styles.containerStyles
            ? currentField.styles.containerStyles
            : null
        ">
            <ng-container *ngIf="!currentField.multiple">
              <span *ngIf="currentField.topLabelAction" class="input-label-top-action" [ngStyle]="
              currentField.styles.topLabelActionStyles
                ? currentField.styles.topLabelActionStyles
                : null
            " (click)="
              currentField.topLabelAction.clickable
                ? currentField.topLabelAction.callback(stepFunctionParams)
                : null
            ">
                {{ currentField.topLabelAction.text }}
              </span>

              <label [for]="currentField.name" class="input-label" [ngStyle]="
              currentField.styles.labelStyles
                ? currentField.styles.labelStyles
                : null
            ">
                {{ currentField.label }}
              </label>

              <label [for]="currentField.name" *ngIf="currentField.sublabel" class="input-label" [ngStyle]="
              currentField.styles.subLabelStyles
                ? currentField.styles.subLabelStyles
                : null
              ">
                {{ currentField.sublabel }}
              </label>

              <ngx-intl-tel-input [cssClass]="'custom'" [preferredCountries]="preferredCountries"
                [enableAutoCountrySelect]="true" [enablePlaceholder]="true" [searchCountryFlag]="true"
                [searchCountryField]="[
                SearchCountryField.Iso2,
                SearchCountryField.Name
              ]" [selectFirstCountry]="false" [selectedCountryISO]="CountryISO.UnitedStates" maxLength="15"
                [phoneValidation]="true" [separateDialCode]="true" [numberFormat]="PhoneNumberFormat.International"
                name="phone" [formControl]="currentField.fieldControl"></ngx-intl-tel-input>

              <span *ngIf="currentField.bottomLabel" class="input-label-bottom" [ngStyle]="
              currentField.styles.bottomLabelStyles
                ? currentField.styles.bottomLabelStyles
                : null
            " (click)="
              currentField.bottomLabel.clickable
                ? currentField.bottomLabel.callback(stepFunctionParams)
                : null
            ">
                {{ currentField.bottomLabel.text }}
              </span>
            </ng-container>
          </div>

          <!-- SELECT INPUTS GO HERE -->
          <div *ngIf="currentField.inputType === 'select'" class="dropdown" [ngStyle]="
            currentField.styles.containerStyles
              ? currentField.styles.containerStyles
              : null
          ">
            <label [for]="currentField.name" class="input-label" [ngStyle]="
              currentField.styles.labelStyles
                ? currentField.styles.labelStyles
                : null
            ">{{ currentField.label }}</label>

            <label [for]="currentField.name" *ngIf="currentField.sublabel" class="input-label" [ngStyle]="
              currentField.styles.subLabelStyles
                ? currentField.styles.subLabelStyles
                : null
            ">
              {{ currentField.sublabel }}
            </label>

            <select [formControlName]="currentField.name" class="input select" [ngStyle]="currentField.styles.fieldStyles
                    ? currentField.styles.fieldStyles
                    : null">
              <option *ngFor="let option of currentField.selectionOptions" [value]="option">{{option}}
              </option>
            </select>
            
            <div class="arrow-icon">
              <img src="{{ env }}/arrow-left.svg" alt="arrow down">
            </div>
          </div>

          <!-- RADIO INPUTS GO HERE -->
          <div *ngIf="currentField.inputType === 'radio'" class="selector" [ngStyle]="
              currentField.styles.containerStyles
                ? currentField.styles.containerStyles
                : null
            ">
            <label [for]="currentField.name" class="input-label" [ngStyle]="
                currentField.styles.labelStyles
                  ? currentField.styles.labelStyles
                  : null
              ">{{ currentField.label }}</label>

            <label [for]="currentField.name" *ngIf="currentField.sublabel" class="input-label" [ngStyle]="
              currentField.styles.subLabelStyles
                ? currentField.styles.subLabelStyles
                : null
              ">
              {{ currentField.sublabel }}
            </label>


            <ng-container *ngFor="let option of currentField.selectionOptions">
              <label [ngClass]="
                  option === currentField.fieldControl.value
                    ? 'selector-option active'
                    : 'selector-option'
                " [ngStyle]="
                  currentField.styles.fieldStyles
                  ? currentField.styles.fieldStyles
                  : null
                " (click)="currentField.fieldControl.setValue(option)">
                <div class="background"></div>
                <input type="radio" [value]="option" [formControlName]="currentField.name" />
                <span>{{ option }}</span>
              </label>
            </ng-container>
          </div>

          <!-- FILE INPUTS GO HERE -->
          <div *ngIf="currentField.inputType === 'file'" [ngStyle]="
              currentField.styles.containerStyles
                ? currentField.styles.containerStyles
                : null
            ">
            <span class="input-label" [ngStyle]="
                currentField.styles.labelStyles
                  ? currentField.styles.labelStyles
                  : null
              ">
              {{ currentField.label }}
            </span>

            <label [for]="currentField.name" *ngIf="currentField.sublabel" class="input-label" [ngStyle]="
            currentField.styles.subLabelStyles
              ? currentField.styles.subLabelStyles
              : null
            ">
              {{ currentField.sublabel }}
            </label>

            <label class="file" [for]="currentField.name" [ngStyle]="applyStylesToImages(currentField)">
              <span *ngIf="currentField.fieldControl.value === ''">Upload / Image</span>
            </label>

            <div *ngIf="currentField.showImageBottomLabel" class="showImageBottomLabel" [ngStyle]="
                currentField.styles.bottomLabelStyles
                  ? currentField.styles.bottomLabelStyles
                  : null
              " (click)="openInputTypeFileSelector(currentField.name)">
              {{ currentField.showImageBottomLabel }}
            </div>

            <input type="file" [id]="currentField.name" [style.display]="'none'"
              (change)="loadFile(currentField, $event)" />
          </div>

          <ng-container *ngIf="currentStepObject['embeddedComponents']">
            <ng-container *ngFor="
                let currentEmbeddedComponent of currentStepObject[
                  'embeddedComponents'
                ]
              ">
              <div *ngIf="
                  currentEmbeddedComponent.afterIndex === currentFieldIndex
                " [ngStyle]="
                  currentEmbeddedComponent.containerStyles
                    ? currentEmbeddedComponent.containerStyles
                    : null
                ">
                <app-dynamic-component [component]="currentEmbeddedComponent.component"
                  [componentInputs]="currentEmbeddedComponent.inputs"
                  [componentOutputs]="currentEmbeddedComponent.outputs"
                  [shouldRemoveItFromTheView]="currentEmbeddedComponent.shouldRerender">
                  ></app-dynamic-component>
              </div>
            </ng-container>
          </ng-container>
        </ng-container>
      </form>

      <!-- LINKS OPCIONALES -->
      <ng-container *ngIf="currentStepObject['optionalLinksTo']">
        <div *ngFor="let groupOfLinks of currentStepObject['optionalLinksTo']" class="optional-links" [ngStyle]="
            groupOfLinks?.styles?.containerStyles
              ? groupOfLinks?.styles?.containerStyles
              : null
          ">
          <span class="title" *ngIf="groupOfLinks.topLabel" [ngStyle]="
              groupOfLinks?.styles?.labelStyles
                ? groupOfLinks?.styles?.labelStyles
                : null
            ">{{groupOfLinks.topLabel}}:</span>
          <ng-container *ngFor="let link of groupOfLinks.links">
            <span class="link" (click)="link.action(stepFunctionParams)" [ngStyle]="
                groupOfLinks?.styles?.fieldStyles
                  ? groupOfLinks?.styles?.fieldStyles
                  : null
              ">{{ link.text }}</span>
          </ng-container>
        </div>
      </ng-container>

      <!-- FOOTER PARA EL CONTADOR DE PREGUNTAS Y LINKS HACIA OTRAS PÁGINAS -->
      <div class="footer">
        <span *ngIf="currentStepObject['bottomLeftAction']" class="bottom-left-action" (click)="
            currentStepObject['bottomLeftAction'].execute(stepFunctionParams)
          ">
          {{ currentStepObject["bottomLeftAction"].text }}
        </span>

        <span *ngIf="currentStepObject['linkFooter']"
          (click)="currentStepObject['linkFooter'].execute(stepFunctionParams)"
          [ngStyle]="currentStepObject['linkFooter'].styles">
          {{ currentStepObject["linkFooter"].text }}
        </span>

        <div class="steps" *ngIf="showStepNumbers">
          <img src="{{ env }}/arrow-down.svg" class="step-icon" alt="questions" />
          {{ currentStepIndex + 1 }} / {{ steps.length }} PASOS
        </div>
      </div>
    </div>

    <div [ngClass]="{
        'bottom-separator':
          dataModel.get(currentStepString).status !== 'INVALID',
        'bottom-separator-disabled':
          dataModel.get(currentStepString).status === 'INVALID'
      }" *ngIf="
        scrollableForm || (!scrollableForm && currentStepIndex === currentStep)
      "></div>

    <!-- BOTON PARA PASAR AL SIGUIENTE PASO O PARA SUBIR EL FORMULARIO -->
    <app-sticky-button *ngIf="
      currentStep === currentStepIndex" [text]="
        dataModel.get(currentStepString).valid
          ? steps[currentStepIndex].stepButtonValidText
          : steps[currentStepIndex].stepButtonInvalidText
      " [bgColor]="steps[currentStep].footerConfig?.bgColor" [mode]="
        dataModel.get(currentStepString).status !== 'INVALID'
          ? 'fixed'
          : 'disabled-fixed'
      " (click)="
        !steps[currentStepIndex].justExecuteCustomScrollToStep
          ? executeStepDataProcessing()
          : steps[currentStepIndex].customScrollToStep(stepFunctionParams)
      "
      [height]="dataModel.get(currentStepString).status !== 'INVALID' ? steps[currentStep].footerConfig?.enabledStyles?.height : dataModel.get(currentStepString).status === 'INVALID' ? steps[currentStep].footerConfig?.disabledStyles?.height : null"
      [fontSize]="dataModel.get(currentStepString).status !== 'INVALID' ? steps[currentStep].footerConfig?.enabledStyles?.fontSize : dataModel.get(currentStepString).status === 'INVALID' ? steps[currentStep].footerConfig?.disabledStyles?.fontSize : null">
    </app-sticky-button>

    <app-bubble-button *ngIf="
      currentStep === currentStepIndex && 
      steps[currentStep].footerConfig?.bubbleConfig
      " [icon]="'/arrow-left.svg'" [text2]="'VISTA'" (leftAction)="currentStep > 0 && shouldScrollBackwards &&
      !steps[currentStep].customScrollToStepBackwards
        ? scrollToStep(this.currentStep - 1, false)
        : steps[currentStep].customScrollToStepBackwards
        ? steps[currentStep].customScrollToStepBackwards(stepFunctionParams)
        : null"
      (rightAction)="steps[currentStep].footerConfig.bubbleConfig.validStep.function ? steps[currentStep].footerConfig.bubbleConfig.validStep.function(stepFunctionParams) : null"
      [mode]="dataModel.get(currentStepString).status !== 'INVALID' ?
          steps[currentStep].footerConfig.bubbleConfig.validStep.mode :
          steps[currentStep].footerConfig.bubbleConfig.invalidStep.mode
        " [bubblesMarginBottom]="dataModel.get(currentStepString).status !== 'INVALID' ? 30 : 53">
    </app-bubble-button>
  </ng-container>
</div>